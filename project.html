<!DOCTYPE html>
<html>
<head>
  <title>Smart Parking System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f7f7f7;
      max-width: 500px;
      margin: auto;
    }
    h2 { color: #333; }
    .status { font-size: 20px; font-weight: bold; margin: 10px 0; }
    input, button {
      display: block;
      margin: 8px 0;
      padding: 8px;
      width: 100%;
    }
    button { cursor: pointer; }
    .free { color: green; }
    .booked { color: orange; }
    .occupied { color: red; }
  </style>
</head>
<body>
  <h2>Smart Parking Slot - 1</h2>
  <div>Status: <span id="status" class="status">Loading...</span></div>
  <div id="bookingInfo"></div>

  <h3>Book Slot</h3>
  <input type="text" id="name" placeholder="Your Name">
  <input type="text" id="location" placeholder="Parking Slot Location">
  <label>Arrival Time (YYYY-MM-DD HH:MM)</label>
  <input type="datetime-local" id="arrival">
  <label>Leaving Time (YYYY-MM-DD HH:MM)</label>
  <input type="datetime-local" id="leave">
  <button onclick="bookSlot()">Book Slot</button>
  <button onclick="cancelBooking()">Cancel Booking</button>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // TODO: Replace with your Firebase config
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    const statusEl = document.getElementById("status");
    const bookingInfoEl = document.getElementById("bookingInfo");

    // Get NTP time
    async function getNTPTime() {
      let res = await fetch("https://worldtimeapi.org/api/ip");
      let data = await res.json();
      return new Date(data.datetime);
    }

    // Listen to slot changes
    db.ref("slot1").on("value", async (snapshot) => {
      let slot = snapshot.val();
      if (!slot) {
        statusEl.textContent = "Free";
        statusEl.className = "status free";
        bookingInfoEl.innerHTML = "";
        return;
      }

      let now = await getNTPTime();
      let arrivalTime = new Date(slot.arrival);
      let leaveTime = new Date(slot.leave);

      if (slot.status === "booked" && now > arrivalTime && slot.occupied !== true) {
        // Auto-expire
        db.ref("slot1").set(null);
        statusEl.textContent = "Free";
        statusEl.className = "status free";
        bookingInfoEl.innerHTML = "";
        return;
      }

      if (slot.status === "occupied" && now > leaveTime) {
        // Free after leaving
        db.ref("slot1").set(null);
        return;
      }

      statusEl.textContent = slot.status.charAt(0).toUpperCase() + slot.status.slice(1);
      statusEl.className = "status " + slot.status;
      bookingInfoEl.innerHTML = `
        <b>Name:</b> ${slot.name}<br>
        <b>Location:</b> ${slot.location}<br>
        <b>Arrival:</b> ${slot.arrival}<br>
        <b>Leave:</b> ${slot.leave}
      `;
    });

    async function bookSlot() {
      let name = document.getElementById("name").value.trim();
      let location = document.getElementById("location").value.trim();
      let arrival = document.getElementById("arrival").value;
      let leave = document.getElementById("leave").value;

      if (!name || !location || !arrival || !leave) {
        alert("Please fill all fields");
        return;
      }

      let now = await getNTPTime();
      if (new Date(arrival) < now) {
        alert("Arrival time must be in the future");
        return;
      }

      db.ref("slot1").set({
        name: name,
        location: location,
        arrival: arrival,
        leave: leave,
        status: "booked",
        occupied: false
      });
    }

    function cancelBooking() {
      db.ref("slot1").set(null);
    }
  </script>
</body>
</html>
